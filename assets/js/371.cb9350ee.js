(window.webpackJsonp=window.webpackJsonp||[]).push([[371],{688:function(a,s,t){"use strict";t.r(s);var e=t(7),r=Object(e.a)({},(function(){var a=this,s=a._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h3",{attrs:{id:"docker-build-命令原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#docker-build-命令原理"}},[a._v("#")]),a._v(" docker build 命令原理")]),a._v(" "),s("ul",[s("li",[a._v("docker build 命令从 Dockerfile 和上下文构建镜像")]),a._v(" "),s("li",[a._v("构建的上下文：位于指定 PATH 或 URL 中的一组文件")]),a._v(" "),s("li",[a._v("构建过程可以引用上下文中的任何文件，例如，构建可以使用 COPY 指令来引用上下文中的文件")]),a._v(" "),s("li",[a._v("PATH：就是本地文件系统上的一个目录路径")]),a._v(" "),s("li",[a._v("URL：Git 地址")]),a._v(" "),s("li",[a._v("个人理解：以设置的上下文为根目录，在 dockerfile 中写的文件路径都会以这个上下文开始找")])]),a._v(" "),s("h4",{attrs:{id:"构建上下文是递归处理的"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#构建上下文是递归处理的"}},[a._v("#")]),a._v(" 构建上下文是递归处理的")]),a._v(" "),s("p",[a._v("PATH 包含任何子目录，URL 包含 repository 及其子模块")]),a._v(" "),s("h3",{attrs:{id:"简单的栗子"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#简单的栗子"}},[a._v("#")]),a._v(" 简单的栗子")]),a._v(" "),s("h4",{attrs:{id:"上下文为当前目录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#上下文为当前目录"}},[a._v("#")]),a._v(" 上下文为当前目录")]),a._v(" "),s("p",[a._v("也是最简单的 docker build 使用方式")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" build "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("ul",[s("li",[a._v("指定 PATH 为  .  ，因此本地目录中的所有文件都会被延迟并发送到 Docker 守护程序")]),a._v(" "),s("li",[a._v("PATH 指定在哪里可以找到 Docker 守护程序上构建的“上下文”的文件")]),a._v(" "),s("li",[a._v("请记住，守护进程可以在远程机器上运行，并且不会在客户端（运行 docker build 的地方）解析 Dockerfile")]),a._v(" "),s("li",[a._v("这意味着 PATH 中的所有文件都会被发送，而不仅仅是 Dockerfile 中列出的 ADD 文件")]),a._v(" "),s("li",[a._v("当看到 Sending build context 消息时，docker 客户端的意思是将上下文从本地机器传输到 Docker 守护进程。")])]),a._v(" "),s("h4",{attrs:{id:"构建由-docker-守护程序-daemon-运行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#构建由-docker-守护程序-daemon-运行"}},[a._v("#")]),a._v(" 构建由 Docker 守护程序（Daemon）运行")]),a._v(" "),s("ul",[s("li",[a._v("而不是 CLI（命令行）运行")]),a._v(" "),s("li",[a._v("构建过程做的第一件事是将整个上下文（递归）发送到守护进程")]),a._v(" "),s("li",[a._v("官方建议：将一个空目录作为上下文起点，并将 Dockerfile 保存在该目录中，仅添加构建 Dockerfile 所需的文件")])]),a._v(" "),s("h4",{attrs:{id:"特别注意"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#特别注意"}},[a._v("#")]),a._v(" 特别注意")]),a._v(" "),s("p",[a._v("不要使用根目录  /  作为构建上下文的 PATH，因为会导致构建时，将硬盘驱动器的全部内容发送到 Docker 守护程序")]),a._v(" "),s("h3",{attrs:{id:"逐一运行"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#逐一运行"}},[a._v("#")]),a._v(" 逐一运行")]),a._v(" "),s("ul",[s("li",[a._v("Docker 守护进程将逐一运行 Dockerfile 中的指令，如有必要，会将每条指令的结果提交到新镜像，最后会输出一个最新镜像的 ID")]),a._v(" "),s("li",[a._v("Docker 守护进程将自动清理发送的上下文")]),a._v(" "),s("li",[a._v("重点：每条指令都是独立运行的，并会创建一个新镜像，因此像 RUN cd /tmp 不会对下一条自定产生任何影响")]),a._v(" "),s("li",[a._v("只要有可能，Docker 就会使用构建缓存来加速 Docker 构建过程，这由控制台输出中的 CACHED 消息指示")])]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" build "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" svendowideit/ambassador "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("internal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" load build definition from Dockerfile                       "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(".1s\n "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" transferring dockerfile: 286B                                       "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(".0s\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("internal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" load .dockerignore                                          "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(".1s\n "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" transferring context: 2B                                            "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(".0s\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),a._v("internal"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" load metadata "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" docker.io/library/alpine:3.2              "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(".4s\n CACHED "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1")]),a._v("/2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" FROM docker.io/library/alpine:3.2@sha256:e9a2035f9d0d7ce  "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(".0s\n CACHED "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),a._v("/2"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" RUN apk "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),a._v(" --no-cache socat                              "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(".0s\n exporting to image                                                     "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(".0s\n "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" exporting layers                                                    "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(".0s\n "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" writing image sha256:1affb80ca37018ac12067fa2af38cc5bcc2a8f09963de  "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(".0s\n "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v(">")]),a._v(" naming to docker.io/svendowideit/ambassador                         "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),a._v(".0s\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br"),s("span",{staticClass:"line-number"},[a._v("2")]),s("br"),s("span",{staticClass:"line-number"},[a._v("3")]),s("br"),s("span",{staticClass:"line-number"},[a._v("4")]),s("br"),s("span",{staticClass:"line-number"},[a._v("5")]),s("br"),s("span",{staticClass:"line-number"},[a._v("6")]),s("br"),s("span",{staticClass:"line-number"},[a._v("7")]),s("br"),s("span",{staticClass:"line-number"},[a._v("8")]),s("br"),s("span",{staticClass:"line-number"},[a._v("9")]),s("br"),s("span",{staticClass:"line-number"},[a._v("10")]),s("br"),s("span",{staticClass:"line-number"},[a._v("11")]),s("br"),s("span",{staticClass:"line-number"},[a._v("12")]),s("br")])]),s("h3",{attrs:{id:"命令行参数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#命令行参数"}},[a._v("#")]),a._v(" 命令行参数")]),a._v(" "),s("h4",{attrs:{id:"f-file"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#f-file"}},[a._v("#")]),a._v(" -f，--file")]),a._v(" "),s("p",[a._v("指定 dockerfile 路径")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" build "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-f")]),a._v(" /path/to/a/Dockerfile "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("不指定的话，默认会读取上下文路径（  .  )下的 dockerfile")]),a._v(" "),s("h4",{attrs:{id:"t-tag"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#t-tag"}},[a._v("#")]),a._v(" -t，--tag")]),a._v(" "),s("p",[a._v("指定构建的镜像名和 tag")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" build "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" ubuntu-nginx:v1 "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v(" \n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("p",[a._v("构建的镜像指定多个 tag")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" build "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" shykes/myapp:1.0.2 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[a._v("-t")]),a._v(" shykes/myapp:latest "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h4",{attrs:{id:"add-host"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#add-host"}},[a._v("#")]),a._v(" --add-host")]),a._v(" "),s("p",[a._v("可以使用一个或多个 --add-host 标志将其他主机添加到容器的 /etc/hosts 文件中")]),a._v(" "),s("div",{staticClass:"language-bash line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[a._v("docker")]),a._v(" build --add-host"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v("docker:10.180.0.1 "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[a._v(".")]),a._v("\n")])]),a._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[a._v("1")]),s("br")])]),s("h4",{attrs:{id:"no-cache"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#no-cache"}},[a._v("#")]),a._v(" --no-cache")]),a._v(" "),s("p",[a._v("构建镜像时不使用缓存")]),a._v(" "),s("h4",{attrs:{id:"network"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#network"}},[a._v("#")]),a._v(" --network")]),a._v(" "),s("p",[a._v("在构建过程中为 RUN 指令设置网络模式")]),a._v(" "),s("p",[a._v("更多参数可以看官方文档\n"),s("a",{attrs:{href:"https://docs.docker.com/engine/reference/commandline/build/",target:"_blank",rel:"noopener"}},[a._v("https://docs.docker.com/engine/reference/commandline/build/")])])])}),[],!1,null,null,null);s.default=r.exports}}]);