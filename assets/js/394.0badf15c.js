(window.webpackJsonp=window.webpackJsonp||[]).push([[394],{712:function(s,a,t){"use strict";t.r(a);var e=t(7),n=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"postgresql通过docker进行高可用部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#postgresql通过docker进行高可用部署"}},[s._v("#")]),s._v(" Postgresql通过docker进行高可用部署")]),s._v(" "),a("p",[s._v("在postgresql官网看了pgpool-II的文档，发现部署比较麻烦")]),s._v(" "),a("p",[s._v("pgpool-II官方文档："),a("a",{attrs:{href:"https://www.pgpool.net/mediawiki/index.php/Documentation",title:"https://www.pgpool.net/mediawiki/index.php/Documentation",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.pgpool.net/mediawiki/index.php/Documentation"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("为了方便快捷还是使用docker部署，然后在dockerhub上找到了相关的镜像：")]),s._v(" "),a("p",[a("code",[s._v("bitnami/postgresql-repmgr")]),s._v("和"),a("code",[s._v("bitnami/pgpool")])]),s._v(" "),a("p",[s._v("从如下截图中可以看到下载量还是很高的：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.yuyanqing.cn/oss/image-bed/col/automate/Snipaste_2023-02-18_13-20-30.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.yuyanqing.cn/oss/image-bed/col/automate/Snipaste_2023-02-18_13-21-27.png",alt:""}})]),s._v(" "),a("p",[s._v("简单介绍就是：")]),s._v(" "),a("p",[a("code",[s._v("bitnami/postgresql-repmgr")]),s._v("是"),a("code",[s._v("PostgreSQL HA")]),s._v("对应的docker镜像，"),a("code",[s._v("PostgreSQL HA")]),s._v(" 是 PostgreSQL 集群解决方案，其中包括 PostgreSQL 复制管理器，这是一个用于管理 PostgreSQL 集群上的复制和故障转移的开源工具。")]),s._v(" "),a("p",[a("code",[s._v("bitnami/pgpool")]),s._v("是"),a("code",[s._v("Pgpool-II")]),s._v(" 对应的docker镜像，是 PostgreSQL 代理。它位于 PostgreSQL 服务器和它们的客户端之间，提供连接池、负载平衡、自动故障转移和复制。")]),s._v(" "),a("h3",{attrs:{id:"试验环境"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#试验环境"}},[s._v("#")]),s._v(" 试验环境")]),s._v(" "),a("ul",[a("li",[s._v("两台机器：server-0：192.168.30.15.2.01、server-1：192.168.30.134")]),s._v(" "),a("li",[s._v("pg-0、pg-1代表postgresql-repmgr容器")]),s._v(" "),a("li",[s._v("pg-0做主库，pg-1做从库")]),s._v(" "),a("li",[s._v("系统：ubuntu20.06")]),s._v(" "),a("li",[s._v("docker版本20.10.12")]),s._v(" "),a("li",[s._v("docker-compose版本1.25.0")])]),s._v(" "),a("p",[s._v("需要准备的镜像")]),s._v(" "),a("p",[a("code",[s._v("bitnami/postgresql-repmgr:15.2.0")]),s._v(" 对应着postgresql15.2.0")]),s._v(" "),a("p",[a("code",[s._v("bitnami/pgpool:4.4.2")])]),s._v(" "),a("h3",{attrs:{id:"修改hosts文件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#修改hosts文件"}},[s._v("#")]),s._v(" 修改hosts文件")]),s._v(" "),a("p",[s._v("分别修改server-0、server-1上的hosts文件")]),s._v(" "),a("p",[a("code",[s._v("sudo vim /etc/hosts")]),s._v("添加下面的内容")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".30.15.2.01 pg-0\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".30.134 pg-1\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h3",{attrs:{id:"部署数据库服务器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署数据库服务器"}},[s._v("#")]),s._v(" 部署数据库服务器")]),s._v(" "),a("p",[s._v("在server-0的创建文件："),a("code",[s._v("touch ~/pgdb/docker-compose.yml")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("version: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2'")]),s._v("\n\nservices:\n  pg-0:\n    image: bitnami/postgresql-repmgr:15.2.0\n    network_mode: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"host"')]),s._v("\n    container_name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pgrepmgr0"')]),s._v("\n    ports:\n      - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5432")]),s._v("\n    volumes:\n      - ./data:/bitnami/postgresql\n    environment:\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("POSTGRESQL_POSTGRES_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("adminpassword\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("POSTGRESQL_USERNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("customuser\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("POSTGRESQL_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("custompassword\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("POSTGRESQL_DATABASE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("customdatabase\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_USERNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("repmgr\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("repmgrpassword\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_PRIMARY_HOST")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pg-0\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_PRIMARY_PORT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5432")]),s._v("\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_PARTNER_NODES")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pg-0,pg-1:5432\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_NODE_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pg-0\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_NODE_NETWORK_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pg-0\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_PORT_NUMBER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5432")]),s._v("\n    restart: always\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("p",[s._v("在server-1的创建文件："),a("code",[s._v("touch ~/pgdb/docker-compose.yml")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("version: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2'")]),s._v("\nservices:\n  pg-1:\n    image: bitnami/postgresql-repmgr:15.2.0\n    network_mode: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"host"')]),s._v("\n    container_name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pgrepmgr1"')]),s._v("\n    volumes:\n      - ./data:/bitnami/postgresql\n    environment:\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("POSTGRESQL_POSTGRES_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("adminpassword\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("POSTGRESQL_USERNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("customuser\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("POSTGRESQL_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("custompassword\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("POSTGRESQL_DATABASE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("customdatabase\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("POSTGRESQL_NUM_SYNCHRONOUS_REPLICAS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_USERNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("repmgr\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("repmgrpassword\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_PRIMARY_HOST")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pg-0\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_PRIMARY_PORT")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5432")]),s._v("\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_PARTNER_NODES")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pg-0,pg-1:5432\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_NODE_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pg-1\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_NODE_NETWORK_NAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("pg-1\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("REPMGR_PORT_NUMBER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5432")]),s._v("\n    restart: always\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("p",[s._v("为了数据持久化，我们把/bitnami/postgresql目录挂载到当前的data目录中")]),s._v(" "),a("p",[a("code",[s._v("docker-compose up")]),s._v("的时候应该会出现权限问题，这个时候我们给新建的data目录相应权限就行了，执行如下命令：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chgrp")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-R")]),s._v(" root data\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-R")]),s._v(" g+rwX data\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("再次"),a("code",[s._v("docker-compose up -d")]),s._v("应该就好了")]),s._v(" "),a("h3",{attrs:{id:"部署pgpool"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署pgpool"}},[s._v("#")]),s._v(" 部署pgpool")]),s._v(" "),a("p",[s._v("server-0中")]),s._v(" "),a("p",[s._v("为了后续方便修改配置文件，我们把配置文件挂载出来")]),s._v(" "),a("p",[s._v("首先在创建配置文件"),a("code",[s._v("./conf/myconf.conf")])]),s._v(" "),a("p",[s._v("然后在创建文件"),a("code",[s._v("touch ~/pgpool/docker-compose.yml")]),s._v("：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("version: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'2.1'")]),s._v("\nservices:\n  pgpool:\n    image: bitnami/pgpool:4.4.2\n    container_name: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pgpool"')]),s._v("\n    network_mode: "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bridge"')]),s._v("\n    ports:\n      - "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9999")]),s._v(":5432\n    volumes:\n      - ./conf/myconf.conf:/config/myconf.conf\n    environment:\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PGPOOL_USER_CONF_FILE")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/config/myconf.conf\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PGPOOL_BACKEND_NODES")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(":pg-0:5432,1:pg-1:5432\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PGPOOL_SR_CHECK_USER")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("repmgr\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PGPOOL_SR_CHECK_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("repmgrpassword\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PGPOOL_ENABLE_LDAP")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("no\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PGPOOL_POSTGRES_USERNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("postgres\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PGPOOL_POSTGRES_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("adminpassword\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PGPOOL_ADMIN_USERNAME")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("admin\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PGPOOL_ADMIN_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("adminpassword\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PGPOOL_ENABLE_LOAD_BALANCING")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("yes\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PGPOOL_POSTGRES_CUSTOM_USERS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("customuser\n      - "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("PGPOOL_POSTGRES_CUSTOM_PASSWORDS")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("custompassword\n    restart: always\n    extra_hosts:\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pg-0:192.168.30.15.2.01"')]),s._v("\n      - "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"pg-1:192.168.30.134"')]),s._v("\n    healthcheck:\n      test: "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"CMD"')]),s._v(", "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/opt/bitnami/scripts/pgpool/healthcheck.sh"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n      interval: 10s\n      timeout: 5s\n      retries: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br")])]),a("p",[s._v("docker-compose up后看没有报错就好了，通过pgpool可以实现数据库的负载均衡和读写分离")]),s._v(" "),a("h3",{attrs:{id:"测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[s._v("#")]),s._v(" 测试")]),s._v(" "),a("h4",{attrs:{id:"测试数据能否共享"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试数据能否共享"}},[s._v("#")]),s._v(" 测试数据能否共享")]),s._v(" "),a("p",[s._v("用navicat连接pgpoll")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.yuyanqing.cn/oss/image-bed/col/automate/2556371-20230209162555665-1515579656.png",alt:""}})]),s._v(" "),a("p",[s._v("创建一个表插入数据后看pg-0和pg-1是否一致")]),s._v(" "),a("p",[s._v("创建users表然后插入两条数据：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.yuyanqing.cn/oss/image-bed/col/automate/2556371-20230209162555366-165919976.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.yuyanqing.cn/oss/image-bed/col/automate/2556371-20230209162553877-80831520537.png",alt:""}})]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.yuyanqing.cn/oss/image-bed/col/automate/2556371-20230209162553567-525067550.png",alt:""}})]),s._v(" "),a("p",[s._v("而且pg-1从库只能读不能写，在pg-1中直接修改数据会报如下错误：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.yuyanqing.cn/oss/image-bed/col/automate/2556371-20230209162563021-531591656.png",alt:""}})]),s._v(" "),a("h4",{attrs:{id:"测试能否故障转移"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#测试能否故障转移"}},[s._v("#")]),s._v(" 测试能否故障转移")]),s._v(" "),a("p",[s._v("我们停掉主库pg-0后查看pgpool服务日志")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.yuyanqing.cn/oss/image-bed/col/automate/2556371-20230209162552575-518838975.png",alt:""}})]),s._v(" "),a("p",[s._v("从日志中可以看到当pg-0挂掉后会再重试5次，如果还访问不了会执行find_primary_node方法查找可以作为主节点的节点，然后把找到节点设置为新的主节点，所以现在pg-1是主节点，这个时候我们访问pgpoll还是能访问的，现在在users表里面再添加一行数据：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.yuyanqing.cn/oss/image-bed/col/automate/2556371-20230209162551706-1377228106.png",alt:""}})]),s._v(" "),a("p",[s._v("然后去pg-1中查看一下，数据是同步的")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.yuyanqing.cn/oss/image-bed/col/automate/2556371-20230209162551336-1762163118.png",alt:""}})]),s._v(" "),a("p",[s._v("我们在把pg-0启动起来。然后看pgpool日志如下，pg-1是可以成功链接到pgpool的")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.yuyanqing.cn/oss/image-bed/col/automate/2556371-20230209162550857-2072920869.png",alt:""}})]),s._v(" "),a("p",[s._v("看pg-1的日志如下：")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://www.yuyanqing.cn/oss/image-bed/col/automate/2556371-20230209162550231-1351065652.png",alt:""}})]),s._v(" "),a("p",[s._v("会发现就算pg-0重新启动器来了，但是pg-1还是主节点不变，pg-0又会成为副节点。")]),s._v(" "),a("p",[s._v("去pg-0中查看，刚刚新插入的数据也能同步的。")])])}),[],!1,null,null,null);a.default=n.exports}}]);